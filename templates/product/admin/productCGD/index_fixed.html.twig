{% extends 'adminTemplate/base.html.twig' %}

{% block title %}ProductCGD - Category Generate Data Approval{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">ProductCGD - Category Generate Data Approval</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ path('admin_index') }}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{{ path('product_index_all') }}">Products</a></li>
                        <li class="breadcrumb-item active">ProductCGD Approval</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="container-fluid">
            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning">
                        <div class="inner">
                            <h3>{{ statistics.pending }}</h3>
                            <p>Pending Approval</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <a href="{{ path('product_cgd_index', {'status': 'pending'}) }}" class="small-box-footer">
                            View Pending <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3>{{ statistics.approved }}</h3>
                            <p>Approved</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <a href="{{ path('product_cgd_index', {'status': 'approved'}) }}" class="small-box-footer">
                            View Approved <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-danger">
                        <div class="inner">
                            <h3>{{ statistics.rejected }}</h3>
                            <p>Rejected</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-times"></i>
                        </div>
                        <a href="{{ path('product_cgd_index', {'status': 'rejected'}) }}" class="small-box-footer">
                            View Rejected <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3>{{ statistics.total }}</h3>
                            <p>Total Entries</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <a href="{{ path('product_cgd_index') }}" class="small-box-footer">
                            View All <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Status Filter Tabs -->
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs">
                        <li class="nav-item">
                            <a class="nav-link {{ current_status == 'pending' ? 'active' : '' }}" 
                               href="{{ path('product_cgd_index', {'status': 'pending'}) }}">
                                <i class="fas fa-clock"></i> Pending ({{ statistics.pending }})
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ current_status == 'approved' ? 'active' : '' }}" 
                               href="{{ path('product_cgd_index', {'status': 'approved'}) }}">
                                <i class="fas fa-check"></i> Approved ({{ statistics.approved }})
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ current_status == 'rejected' ? 'active' : '' }}" 
                               href="{{ path('product_cgd_index', {'status': 'rejected'}) }}">
                                <i class="fas fa-times"></i> Rejected ({{ statistics.rejected }})
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <!-- Search and Actions -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <form method="GET" class="form-inline">
                                <div class="input-group">
                                    <input type="text" name="search" class="form-control" 
                                           placeholder="Search by name, SKU, or description..." 
                                           value="{{ search_query }}">
                                    <div class="input-group-append">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                    </div>
                                </div>
                                {% if current_status != 'pending' %}
                                    <input type="hidden" name="status" value="{{ current_status }}">
                                {% endif %}
                            </form>
                        </div>
                        <div class="col-md-6 text-right">
                            <button type="button" id="bulk-approve-btn" class="btn btn-success" disabled>
                                <i class="fas fa-check"></i> Approve Selected
                            </button>
                            <button type="button" id="bulk-reject-btn" class="btn btn-danger" disabled>
                                <i class="fas fa-times"></i> Reject Selected
                            </button>
                            <button type="button" id="convert-approved-btn" class="btn btn-primary" disabled>
                                <i class="fas fa-sync"></i> Convert to Products
                            </button>
                        </div>
                    </div>

                    <!-- ProductCGD Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="select-all">
                                    </th>
                                    <th>Name</th>
                                    <th>SKU</th>
                                    <th>Category ID</th>
                                    <th>Brand ID</th>
                                    <th>Status</th>
                                    <th>Product ID</th>
                                    <th>Created</th>
                                    <th>Created By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if product_cgds|length > 0 %}
                                    {% for product_cgd in product_cgds %}
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="product-cgd-checkbox" value="{{ product_cgd.id }}">
                                            </td>
                                            <td>
                                                <strong>{{ product_cgd.name }}</strong>
                                                {% if product_cgd.description %}
                                                    <br><small class="text-muted">{{ product_cgd.description|slice(0, 100) }}{% if product_cgd.description|length > 100 %}...{% endif %}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if product_cgd.sku %}
                                                    <code>{{ product_cgd.sku }}</code>
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if product_cgd.categoryId %}
                                                    <span class="badge badge-info">{{ product_cgd.categoryId }}</span>
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if product_cgd.brandId %}
                                                    <span class="badge badge-info">{{ product_cgd.brandId }}</span>
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="label {{ product_cgd.statusBadgeClass }}">
                                                    {{ product_cgd.statusLabel }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if product_cgd.productId %}
                                                    <a href="{{ path('product_edit', {'id': product_cgd.productId}) }}" class="badge badge-success">
                                                        {{ product_cgd.productId }}
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ product_cgd.created|date('Y-m-d H:i') }}</td>
                                            <td>
                                                {% if product_cgd.createdBy %}
                                                    <span class="badge badge-secondary">{{ product_cgd.createdBy.id }}</span>
                                                {% else %}
                                                    <span class="text-muted">System</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ path('product_cgd_show', {'id': product_cgd.id}) }}" 
                                                       class="btn btn-info" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% if product_cgd.isPending() %}
                                                        <button type="button" class="btn btn-success approve-btn" 
                                                                data-id="{{ product_cgd.id }}" title="Approve">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-danger reject-btn" 
                                                                data-id="{{ product_cgd.id }}" title="Reject">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="10" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-3x mb-3"></i>
                                            <p>No ProductCGD entries found for the current criteria.</p>
                                            {% if search_query %}
                                                <p>Try adjusting your search terms.</p>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if product_cgds|length > 0 %}
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <small class="text-muted">
                                    Showing {{ product_cgds|length }} entries
                                </small>
                            </div>
                            <div>
                                {% if current_page > 1 %}
                                    <a href="{{ path('product_cgd_index', {'page': current_page - 1, 'status': current_status, 'search': search_query}) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-chevron-left"></i> Previous
                                    </a>
                                {% endif %}
                                <span class="mx-2">Page {{ current_page }}</span>
                                {% if product_cgds|length == 20 %}
                                    <a href="{{ path('product_cgd_index', {'page': current_page + 1, 'status': current_status, 'search': search_query}) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        Next <i class="fas fa-chevron-right"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Reject Modal -->
<div class="modal fade" id="bulk-reject-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Selected ProductCGD Entries</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ path('product_cgd_bulk_reject') }}">
                <div class="modal-body">
                    <p>Please provide a reason for rejecting the selected entries:</p>
                    <div class="form-group">
                        <textarea name="rejection_reason" class="form-control" rows="3" 
                                  placeholder="Enter rejection reason..." required></textarea>
                    </div>
                    <div id="selected-ids-container"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject Selected</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Convert Approved Modal -->
<div class="modal fade" id="convert-approved-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Convert Approved ProductCGD to Products</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>This will convert the selected approved ProductCGD entries to actual Product entities.</p>
                <p><strong>Note:</strong> This process may take some time for large numbers of products.</p>
                <div id="convert-selected-ids-container"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ path('product_cgd_convert_approved') }}" style="display: inline;">
                    <div id="convert-form-ids-container"></div>
                    <button type="submit" class="btn btn-primary">Convert to Products</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
$(document).ready(function() {
    // Handle select all checkbox
    $('#select-all').change(function() {
        $('.product-cgd-checkbox').prop('checked', $(this).is(':checked'));
        updateBulkActionButtons();
    });

    // Handle individual checkboxes
    $('.product-cgd-checkbox').change(function() {
        updateBulkActionButtons();
        updateSelectAllCheckbox();
    });

    // Update bulk action buttons state
    function updateBulkActionButtons() {
        const checkedCount = $('.product-cgd-checkbox:checked').length;
        $('#bulk-approve-btn, #bulk-reject-btn, #convert-approved-btn').prop('disabled', checkedCount === 0);
    }

    // Update select all checkbox state
    function updateSelectAllCheckbox() {
        const totalCheckboxes = $('.product-cgd-checkbox').length;
        const checkedCheckboxes = $('.product-cgd-checkbox:checked').length;
        
        if (checkedCheckboxes === 0) {
            $('#select-all').prop('indeterminate', false).prop('checked', false);
        } else if (checkedCheckboxes === totalCheckboxes) {
            $('#select-all').prop('indeterminate', false).prop('checked', true);
        } else {
            $('#select-all').prop('indeterminate', true);
        }
    }

    // Bulk approve
    $('#bulk-approve-btn').click(function() {
        const selectedIds = getSelectedIds();
        if (selectedIds.length === 0) {
            alert('Please select at least one ProductCGD entry to approve.');
            return;
        }

        if (confirm(`Are you sure you want to approve ${selectedIds.length} selected entries?`)) {
            const form = $('<form method="POST" action="{{ path('product_cgd_bulk_approve') }}"></form>');
            selectedIds.forEach(id => {
                form.append(`<input type="hidden" name="product_cgd_ids[]" value="${id}">`);
            });
            $('body').append(form);
            form.submit();
        }
    });

    // Bulk reject
    $('#bulk-reject-btn').click(function() {
        const selectedIds = getSelectedIds();
        if (selectedIds.length === 0) {
            alert('Please select at least one ProductCGD entry to reject.');
            return;
        }

        // Populate modal with selected IDs
        $('#selected-ids-container').html('');
        selectedIds.forEach(id => {
            $('#selected-ids-container').append(`<input type="hidden" name="product_cgd_ids[]" value="${id}">`);
        });

        $('#bulk-reject-modal').modal('show');
    });

    // Convert approved
    $('#convert-approved-btn').click(function() {
        const selectedIds = getSelectedIds();
        if (selectedIds.length === 0) {
            alert('Please select at least one approved ProductCGD entry to convert.');
            return;
        }

        // Populate modal with selected IDs
        $('#convert-selected-ids-container').html(`<p><strong>Selected IDs:</strong> ${selectedIds.join(', ')}</p>`);
        $('#convert-form-ids-container').html('');
        selectedIds.forEach(id => {
            $('#convert-form-ids-container').append(`<input type="hidden" name="product_cgd_ids[]" value="${id}">`);
        });

        $('#convert-approved-modal').modal('show');
    });

    // Get selected checkbox values
    function getSelectedIds() {
        return $('.product-cgd-checkbox:checked').map(function() {
            return $(this).val();
        }).get();
    }

    // Individual approve button
    $('.approve-btn').click(function() {
        const id = $(this).data('id');
        if (confirm('Are you sure you want to approve this ProductCGD entry?')) {
            const form = $('<form method="POST" action="{{ path('product_cgd_approve', {'id': '__ID__'}) }}"></form>'.replace('__ID__', id));
            $('body').append(form);
            form.submit();
        }
    });

    // Individual reject button
    $('.reject-btn').click(function() {
        const id = $(this).data('id');
        const reason = prompt('Please provide a reason for rejection:');
        if (reason !== null) {
            const form = $('<form method="POST" action="{{ path('product_cgd_reject', {'id': '__ID__'}) }}"></form>'.replace('__id__', id));
            form.append(`<input type="hidden" name="rejection_reason" value="${reason}">`);
            $('body').append(form);
            form.submit();
        }
    });
});
</script>
{% endblock %}

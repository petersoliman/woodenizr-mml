{% extends 'adminTemplate/base.html.twig' %}

{% block title %}ProductCGD Approval{% endblock %}

{% block body %}

<!-- Page header -->
<div class="page-header page-header-default">
    <div class="page-header-content">
        <div class="page-title">
            <h4>ProductCGD Approval</h4>
        </div>
    </div>
    <div class="breadcrumb-line">
        <ul class="breadcrumb">
            <li><a href="{{ path('admin_index') }}"><i class="icon-home2 position-left"></i> Home</a></li>
            <li><a href="{{ path('product_index_all') }}">Products</a></li>
            <li class="active">CGData Approval</li>
        </ul>
    </div>
</div>
<!-- /page header -->

    <div class="content">
        <div class="container-fluid">
            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-lg-3 col-sm-6">
                    <div class="panel panel-flat">
                        <div class="panel-body text-center">
                            <div class="icon-object border-warning text-warning">
                                <i class="icon-clock"></i>
                            </div>
                            <h3 class="no-margin">{{ statistics.pending }}</h3>
                            <p class="text-muted">Pending Approval</p>
                            <a href="{{ path('product_cgd_index', {'status': 'pending'}) }}" class="btn btn-xs btn-warning">
                                View Pending <i class="icon-arrow-right8"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6">
                    <div class="panel panel-flat">
                        <div class="panel-body text-center">
                            <div class="icon-object border-success text-success">
                                <i class="icon-checkmark3"></i>
                            </div>
                            <h3 class="no-margin">{{ statistics.approved }}</h3>
                            <p class="text-muted">Approved</p>
                            <a href="{{ path('product_cgd_index', {'status': 'approved'}) }}" class="btn btn-xs btn-success">
                                View Approved <i class="icon-arrow-right8"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6">
                    <div class="panel panel-flat">
                        <div class="panel-body text-center">
                            <div class="icon-object border-danger text-danger">
                                <i class="icon-cross2"></i>
                            </div>
                            <h3 class="no-margin">{{ statistics.rejected }}</h3>
                            <p class="text-muted">Rejected</p>
                            <a href="{{ path('product_cgd_index', {'status': 'rejected'}) }}" class="btn btn-xs btn-danger">
                                View Rejected <i class="icon-arrow-right8"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6">
                    <div class="panel panel-flat">
                        <div class="panel-body text-center">
                            <div class="icon-object border-info text-info">
                                <i class="icon-database"></i>
                            </div>
                            <h3 class="no-margin">{{ statistics.converted }}</h3>
                            <p class="text-muted">Added to DB</p>
                            <a href="{{ path('product_cgd_index', {'status': 'converted'}) }}" class="btn btn-xs btn-info">
                                View Converted <i class="icon-arrow-right8"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Card -->
            <div class="panel panel-flat">
                <div class="panel-heading">
                    <h6 class="panel-title">ProductCGD Entries</h6>
                    <div class="heading-elements">
                        <ul class="nav nav-tabs nav-tabs-highlight">
                            <li class="{{ current_status == 'pending' ? 'active' : '' }}">
                                <a href="{{ path('product_cgd_index', {'status': 'pending'}) }}">
                                    <i class="icon-clock position-left"></i> Pending ({{ statistics.pending }})
                                </a>
                            </li>
                            <li class="{{ current_status == 'approved' ? 'active' : '' }}">
                                <a href="{{ path('product_cgd_index', {'status': 'approved'}) }}">
                                    <i class="icon-checkmark3 position-left"></i> Approved ({{ statistics.approved }})
                                </a>
                            </li>
                            <li class="{{ current_status == 'rejected' ? 'active' : '' }}">
                                <a href="{{ path('product_cgd_index', {'status': 'rejected'}) }}">
                                    <i class="icon-cross2 position-left"></i> Rejected ({{ statistics.rejected }})
                                </a>
                            </li>
                            <li class="{{ current_status == 'converted' ? 'active' : '' }}">
                                <a href="{{ path('product_cgd_index', {'status': 'converted'}) }}">
                                    <i class="icon-database position-left"></i> Added to DB ({{ statistics.converted }})
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="panel-body">
                    <!-- Search Bar -->
                    <div class="row">
                        <div class="col-md-6">
                            <form method="GET" class="form-horizontal">
                                <div class="input-group">
                                    <input type="text" name="search" class="form-control" 
                                           placeholder="Search by name, SKU, or description..." value="{{ search_query }}">
                                    <div class="input-group-btn">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="icon-search4"></i> Search
                                        </button>
                                    </div>
                                </div>
                                {% if current_status != 'pending' %}
                                    <input type="hidden" name="status" value="{{ current_status }}">
                                {% endif %}
                            </form>
                        </div>
                        <div class="col-md-6 text-right">
                            {# Approved tab: only Add to DB, Reject All, Back to Pending (per-row already handled) #}
                            {% if current_status == 'approved' %}
                                <button type="button" id="add-to-database" class="btn btn-success btn-sm">
                                    <i class="icon-database"></i> ADD TO DATABASE
                                </button>
                                <button type="button" id="bulk-reject" class="btn btn-danger btn-sm" disabled>
                                    <i class="icon-cross2"></i> Reject Selected
                                </button>
                                <button type="button" id="reject-all" class="btn btn-warning btn-sm">
                                    <i class="icon-blocked"></i> Reject All
                                </button>
                            {% endif %}

                            {# Pending tab: Approve/Reject controls #}
                            {% if current_status == 'pending' %}
                                <button type="button" id="bulk-approve" class="btn btn-success btn-sm" disabled>
                                    <i class="icon-checkmark3"></i> Approve Selected
                                </button>
                                <button type="button" id="bulk-reject" class="btn btn-danger btn-sm" disabled>
                                    <i class="icon-cross2"></i> Reject Selected
                                </button>
                                <button type="button" id="approve-all" class="btn btn-primary btn-sm">
                                    <i class="icon-checkmark4"></i> Approve All
                                </button>
                                <button type="button" id="reject-all" class="btn btn-warning btn-sm">
                                    <i class="icon-blocked"></i> Reject All
                                </button>
                            {% endif %}

                            {# Rejected tab: only Delete All Rejected and Approve All/back to pending handled per-row #}
                            {% if current_status == 'rejected' %}
                                <button type="button" id="delete-rejected-all" class="btn btn-danger btn-sm">
                                    <i class="icon-trash"></i> Delete All Rejected
                                </button>
                                <button type="button" id="approve-all" class="btn btn-primary btn-sm">
                                    <i class="icon-checkmark4"></i> Approve All
                                </button>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">
                                        <input type="checkbox" id="product-cgd-select-all" class="product-cgd-checkbox-main">
                                    </th>
                                    <th width="25%">Name</th>
                                    <th width="10%">SKU</th>
                                    <th width="8%">Category</th>
                                    <th width="8%">Brand</th>
                                    <th width="10%">Status</th>
                                    <th width="8%">Product ID</th>
                                    <th width="12%">Created</th>
                                    <th width="14%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if product_cgds|length > 0 %}
                                    {% for product_cgd in product_cgds %}
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="product-cgd-checkbox-item" value="{{ product_cgd.id }}">
                                            </td>
                                            <td>
                                                <strong>{{ product_cgd.name }}</strong>
                                                {% if product_cgd.description %}
                                                    <br><small class="text-muted">{{ product_cgd.description|slice(0, 50) }}...</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if product_cgd.sku %}
                                                    <span class="label label-info">{{ product_cgd.sku }}</span>
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if product_cgd.categoryId %}
                                                    <span class="label label-info">{{ product_cgd.categoryId }}</span>
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if product_cgd.brandId %}
                                                    <span class="label label-info">{{ product_cgd.brandId }}</span>
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="label label-{{ product_cgd.status == 'pending' ? 'warning' : (product_cgd.status == 'approved' ? 'success' : 'danger') }}">
                                                    {{ product_cgd.status|title }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if product_cgd.productId %}
                                                    <a href="{{ path('product_edit', {'id': product_cgd.productId}) }}" class="label label-success">
                                                        {{ product_cgd.productId }}
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ product_cgd.created|date('Y-m-d H:i') }}</td>
                                            <td>
                                                <div class="btn-group">
                                                    <a href="{{ path('product_cgd_show', {'id': product_cgd.id}) }}" 
                                                       class="btn btn-xs btn-info" title="View Details">
                                                        <i class="icon-eye"></i>
                                                    </a>
                                                    {% if current_status == 'rejected' %}
                                                        <form method="POST" action="{{ path('product_cgd_approve', {'id': product_cgd.id}) }}" style="display:inline;">
                                                            <button type="submit" class="btn btn-xs btn-success" title="Approve">
                                                                <i class="icon-checkmark3"></i>
                                                            </button>
                                                        </form>
                                                        <form method="POST" action="{{ path('product_cgd_move_pending', {'id': product_cgd.id}) }}" style="display:inline;">
                                                            <button type="submit" class="btn btn-xs btn-default" title="Back to Pending">
                                                                <i class="icon-undo2"></i>
                                                            </button>
                                                        </form>
                                                        <form method="POST" action="{{ path('product_cgd_delete_rejected') }}" style="display:inline;" onsubmit="return confirm('Delete this rejected entry?');">
                                                            <input type="hidden" name="product_cgd_ids[]" value="{{ product_cgd.id }}">
                                                            <button type="submit" class="btn btn-xs btn-danger" title="Delete">
                                                                <i class="icon-trash"></i>
                                                            </button>
                                                        </form>
                                                    {% elseif current_status == 'approved' %}
                                                        <form method="POST" action="{{ path('product_cgd_convert_one', {'id': product_cgd.id}) }}" style="display:inline;">
                                                            <button type="submit" class="btn btn-xs btn-success" title="Add to DB">
                                                                <i class="icon-database"></i>
                                                            </button>
                                                        </form>
                                                        <form method="POST" action="{{ path('product_cgd_move_pending', {'id': product_cgd.id}) }}" style="display:inline;">
                                                            <button type="submit" class="btn btn-xs btn-default" title="Back to Pending">
                                                                <i class="icon-undo2"></i>
                                                            </button>
                                                        </form>
                                                        <button type="button" class="btn btn-xs btn-danger reject-btn" 
                                                                data-id="{{ product_cgd.id }}" title="Reject">
                                                            <i class="icon-cross2"></i>
                                                        </button>
                                                    {% elseif current_status == 'pending' %}
                                                        <button type="button" class="btn btn-xs btn-success approve-btn" 
                                                                data-id="{{ product_cgd.id }}" title="Approve">
                                                            <i class="icon-checkmark3"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-xs btn-danger reject-btn" 
                                                                data-id="{{ product_cgd.id }}" title="Reject">
                                                            <i class="icon-cross2"></i>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="9" class="text-center text-muted">
                                            <div class="empty-state">
                                                <i class="icon-inbox icon-3x text-muted"></i>
                                                <h4>No ProductCGD entries found</h4>
                                                <p class="text-muted">
                                                    {% if search_query %}
                                                        No entries match your search criteria. Try adjusting your search terms.
                                                    {% else %}
                                                        There are no entries in the current status. 
                                                        {% if current_status == 'pending' %}
                                                            All entries have been processed.
                                                        {% elseif current_status == 'approved' %}
                                                            No entries have been approved yet.
                                                        {% elseif current_status == 'rejected' %}
                                                            No entries have been rejected.
                                                        {% endif %}
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if product_cgds|length > 0 %}
                        <div class="text-center">
                            <ul class="pagination pagination-sm">
                                {% if current_page > 1 %}
                                    <li>
                                        <a href="{{ path('product_cgd_index', {'page': current_page - 1, 'status': current_status, 'search': search_query}) }}">
                                            <i class="icon-arrow-left8"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                <li class="active">
                                    <span>Page {{ current_page }}</span>
                                </li>
                                
                                {% if product_cgds|length == 20 %}
                                    <li>
                                        <a href="{{ path('product_cgd_index', {'page': current_page + 1, 'status': current_status, 'search': search_query}) }}">
                                            <i class="icon-arrow-right8"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                            
                            <div class="text-muted">
                                <small>Showing {{ product_cgds|length }} entries</small>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Simple Reject Modal -->
<div id="reject-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background-color: rgba(0,0,0,0.5);">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; min-width: 400px; max-width: 600px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4 style="margin: 0;">Reject Selected Entries</h4>
            <button type="button" onclick="hideRejectModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <p>Please provide a reason for rejecting the selected entries:</p>
            <textarea name="rejection_reason" id="rejection-reason" rows="3" 
                      style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                      placeholder="Enter rejection reason..." required></textarea>
        </div>
        
        <div id="reject-ids"></div>
        
        <div style="text-align: right;">
            <button type="button" onclick="hideRejectModal()" style="margin-right: 10px; padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button type="button" onclick="submitRejectForm()" style="padding: 8px 16px; border: none; background: #d9534f; color: white; border-radius: 4px; cursor: pointer;">Reject Selected</button>
        </div>
    </div>
</div>
{% endblock body %}

{% block javascripts %}
{{ parent() }}
<script>
// Immediate debugging - run this right away
console.log('=== IMMEDIATE DEBUGGING ===');
console.log('Document ready state:', document.readyState);
console.log('jQuery available:', typeof $ !== 'undefined');

    // Initialize checkboxes when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const selectAll = document.getElementById('product-cgd-select-all');
        const productCheckboxes = document.querySelectorAll('.product-cgd-checkbox-item');
        
        if (selectAll) {
            selectAll.addEventListener('change', function() {
                toggleAllCheckboxes(this.checked);
            });
        }
        
        productCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectAllState();
                updateBulkButtons();
            });
        });
        
        // Initialize button states
        updateBulkButtons();
    });

    // Helper functions
    function toggleAllCheckboxes(checked) {
        const productCheckboxes = document.querySelectorAll('.product-cgd-checkbox-item');
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });
        updateSelectAllState();
        updateBulkButtons();
    }
    
    function updateSelectAllState() {
        const selectAll = document.getElementById('product-cgd-select-all');
        const productCheckboxes = document.querySelectorAll('.product-cgd-checkbox-item');
        const total = productCheckboxes.length;
        const checked = document.querySelectorAll('.product-cgd-checkbox-item:checked').length;
        
        if (selectAll) {
            if (checked === 0) {
                selectAll.indeterminate = false;
                selectAll.checked = false;
            } else if (checked === total) {
                selectAll.indeterminate = false;
                selectAll.checked = true;
            } else {
                selectAll.indeterminate = true;
            }
        }
    }
    
    function updateBulkButtons() {
        const checked = document.querySelectorAll('.product-cgd-checkbox-item:checked').length;
        const bulkApprove = document.getElementById('bulk-approve');
        const bulkReject = document.getElementById('bulk-reject');
        
        if (bulkApprove) bulkApprove.disabled = checked === 0;
        if (bulkReject) bulkReject.disabled = checked === 0;
    }
    
    function getSelectedIds() {
        const checkedCheckboxes = document.querySelectorAll('.product-cgd-checkbox-item:checked');
        const ids = Array.from(checkedCheckboxes).map(cb => cb.value);
        console.log('getSelectedIds - Checked checkboxes:', checkedCheckboxes.length, 'IDs:', ids);
        return ids;
    }
    
    function submitBulkAction(action, ids) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = action;
        
        ids.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'product_cgd_ids[]';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
    
    function submitIndividualAction(action, rejectionReason = null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = action;
        
        if (rejectionReason) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'rejection_reason';
            input.value = rejectionReason;
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
    
    function showRejectModal(ids) {
        const modal = document.getElementById('reject-modal');
        const rejectIds = document.getElementById('reject-ids');
        
        // Clear previous IDs
        if (rejectIds) {
            rejectIds.innerHTML = '';
            
            // Add hidden inputs for each selected ID
            ids.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'product_cgd_ids[]';
                input.value = id;
                rejectIds.appendChild(input);
            });
            
            // Show count of selected entries
            const countDisplay = document.createElement('div');
            countDisplay.style.cssText = 'background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 4px; margin-bottom: 15px;';
            countDisplay.innerHTML = `<strong>${ids.length} entries</strong> selected for rejection`;
            rejectIds.appendChild(countDisplay);
        }
        
        if (modal) {
            modal.style.display = 'block';
        }
    }
    
    function submitRejectForm() {
        const reason = document.getElementById('rejection-reason').value.trim();
        const rejectIds = document.getElementById('reject-ids');
        
        if (!reason) {
            alert('Please provide a rejection reason.');
            return;
        }
        
        // Get selected IDs
        const idInputs = rejectIds.querySelectorAll('input[name="product_cgd_ids[]"]');
        const ids = Array.from(idInputs).map(input => input.value);
        
        if (ids.length === 0) {
            alert('No entries selected for rejection.');
            return;
        }
        
        // Hide modal first
        hideRejectModal();
        
        // Create and submit form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ path('product_cgd_bulk_reject') }}';
        
        // Add rejection reason
        const reasonInput = document.createElement('input');
        reasonInput.type = 'hidden';
        reasonInput.name = 'rejection_reason';
        reasonInput.value = reason;
        form.appendChild(reasonInput);
        
        // Add product IDs
        ids.forEach(id => {
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'product_cgd_ids[]';
            idInput.value = id;
            form.appendChild(idInput);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
    
    function hideRejectModal() {
        const modal = document.getElementById('reject-modal');
        const textarea = document.getElementById('rejection-reason');
        
        if (modal) {
            modal.style.display = 'none';
        }
        
        if (textarea) {
            textarea.value = '';
        }
    }
    
    // Add event listeners to action buttons
    const addToDatabase = document.getElementById('add-to-database');
    const bulkApprove = document.getElementById('bulk-approve');
    const bulkReject = document.getElementById('bulk-reject');
    const approveAll = document.getElementById('approve-all');
    const rejectAll = document.getElementById('reject-all');
    const deleteRejectedAll = document.getElementById('delete-rejected-all');
    
    if (addToDatabase) {
        addToDatabase.addEventListener('click', function() {
            // Get all approved ProductCGD entries (not just selected ones)
            const approvedCheckboxes = document.querySelectorAll('.product-cgd-checkbox-item');
            const approvedIds = [];
            let categoryId = null;
            let brandId = null;
            
            approvedCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const statusCell = row.querySelector('td:nth-child(6)'); // Status column
                if (statusCell) {
                    const statusText = statusCell.textContent.toLowerCase().trim();
                    console.log('Status text:', statusText, 'for checkbox:', checkbox.value);
                    if (statusText.includes('approved')) {
                        approvedIds.push(checkbox.value);
                        
                        // Get category and brand IDs from the first approved entry
                        if (categoryId === null) {
                            const categoryCell = row.querySelector('td:nth-child(4)'); // Category column
                            const brandCell = row.querySelector('td:nth-child(5)'); // Brand column
                            
                            if (categoryCell) {
                                const categoryText = categoryCell.textContent.trim();
                                categoryId = parseInt(categoryText) || null;
                            }
                            
                            if (brandCell) {
                                const brandText = brandCell.textContent.trim();
                                brandId = parseInt(brandText) || null;
                            }
                        }
                    }
                }
            });
            
            console.log('Found approved IDs:', approvedIds);
            console.log('Category ID:', categoryId, 'Brand ID:', brandId);
            
            if (approvedIds.length === 0) {
                alert('No approved entries found. Please approve some entries first before adding them to the database.');
                return;
            }
            
            if (!categoryId || !brandId) {
                alert('Could not determine category or brand ID. Please check the data.');
                return;
            }
            
            if (confirm(`Are you sure you want to add ${approvedIds.length} approved entries to the main product database? This action cannot be undone.`)) {
                console.log('Adding to database:', approvedIds);
                
                // Prepare products array in the format expected by cgdataSaveProducts
                const products = [];
                approvedIds.forEach(id => {
                    const row = document.querySelector(`input[value="${id}"]`).closest('tr');
                    const nameCell = row.querySelector('td:nth-child(2)'); // Name column
                    const skuCell = row.querySelector('td:nth-child(3)'); // SKU column
                    
                    const product = {
                        name: nameCell ? nameCell.querySelector('strong').textContent.trim() : '',
                        sku: skuCell ? skuCell.textContent.trim() : '',
                        description: '', // We can add this if needed
                        price: 0, // Default price
                        images: [], // Empty images array
                        technical_specs: {} // Empty specs
                    };
                    
                    products.push(product);
                });
                
                console.log('Prepared products array:', products);
                
                // Convert ALL approved CGD entries to real products
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ path('product_cgd_convert_approved') }}';
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
    
    if (bulkApprove) {
        bulkApprove.addEventListener('click', function() {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                alert('Please select at least one entry to approve.');
                return;
            }
            
            if (confirm(`Are you sure you want to approve ${ids.length} selected entries?`)) {
                submitBulkAction('{{ path('product_cgd_bulk_approve') }}', ids);
            }
        });
    }

    if (approveAll) {
        approveAll.addEventListener('click', function() {
            if (!confirm('Approve ALL entries in current status?')) return;
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ path('product_cgd_approve_all') }}';

            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status';
            statusInput.value = '{{ current_status }}';
            form.appendChild(statusInput);

            document.body.appendChild(form);
            form.submit();
        });
    }

    if (rejectAll) {
        rejectAll.addEventListener('click', function() {
            const reason = prompt('Provide a reason for rejecting ALL entries in current status:');
            if (reason === null) return;
            if (!confirm('Reject ALL entries in current status?')) return;

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ path('product_cgd_reject_all') }}';

            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status';
            statusInput.value = '{{ current_status }}';
            form.appendChild(statusInput);

            const reasonInput = document.createElement('input');
            reasonInput.type = 'hidden';
            reasonInput.name = 'rejection_reason';
            reasonInput.value = reason;
            form.appendChild(reasonInput);

            document.body.appendChild(form);
            form.submit();
        });
    }

    if (deleteRejectedAll) {
        deleteRejectedAll.addEventListener('click', function() {
            if ('{{ current_status }}' !== 'rejected') {
                alert('Delete All is only available on the Rejected tab.');
                return;
            }
            if (!confirm('Permanently delete ALL rejected CGD entries? This cannot be undone.')) return;

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ path('product_cgd_delete_rejected') }}';

            document.body.appendChild(form);
            form.submit();
        });
    }
    
    if (bulkReject) {
        bulkReject.addEventListener('click', function() {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                alert('Please select at least one entry to reject.');
                return;
            }
            
            console.log('Rejecting IDs:', ids);
            console.log('Total checkboxes:', document.querySelectorAll('.product-cgd-checkbox-item').length);
            console.log('Checked checkboxes:', document.querySelectorAll('.product-cgd-checkbox-item:checked').length);
            showRejectModal(ids);
        });
    }
    
    // Individual approve/reject buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('approve-btn')) {
            const id = e.target.getAttribute('data-id');
            
            if (confirm('Are you sure you want to approve this ProductCGD entry?')) {
                submitIndividualAction('{{ path('product_cgd_approve', {'id': '__ID__'}) }}'.replace('__ID__', id));
            }
        }
        
        if (e.target.classList.contains('reject-btn')) {
            const id = e.target.getAttribute('data-id');
            
            const reason = prompt('Please provide a reason for rejection:');
            if (reason && reason.trim() !== '') {
                submitIndividualAction('{{ path('product_cgd_reject', {'id': '__ID__'}) }}'.replace('__ID__', id), reason.trim());
            } else if (reason !== null) {
                alert('Please provide a rejection reason.');
            }
        }
    });
</script>
{% endblock %}

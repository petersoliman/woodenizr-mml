{% extends 'adminTemplate/base.html.twig' %}
{% set page_title %}GCData Batch Monitor{% endset %}
{# Updated by: cursor | Date: 2025-09-01 15:40 | Reason: Show only total ready products #}

{% block body %}
<div class="panel panel-flat">
    <div class="panel-heading">
        <h5 class="panel-title">GCData Batch Monitor</h5>
    </div>
    <div class="panel-body">
        <div style="font-weight:bold; font-size:16px;">Total Ready in Queue: <span id="js-total">0</span></div>
        <div class="text-right" style="margin-top:10px;">
            <button id="js-force" class="btn btn-primary" style="display:none;"><i class="icon-rocket"></i> Force Cataloug Update</button>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
(function(){
    var readyCountUrl = "{{ path('product_gcdata_ready_count') }}";
    var runUrl = "{{ path('product_gcdata_run') }}";
    // Updated by: cursor | Date: 2025-09-01 15:50 | Reason: Show Force Update when Ready >= 1
    function refresh(){
        fetch(readyCountUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(function(r){ return r.json(); })
            .then(function(d){
                if (d && d.success) {
                    var count = Number(d.count||0);
                    var el = document.getElementById('js-total');
                    if (el) { el.textContent = count; }
                    var btn = document.getElementById('js-force');
                    if (btn) { btn.style.display = count >= 1 ? '' : 'none'; }
                }
            })
            .catch(function(){});
    }
    var forceBtn = document.getElementById('js-force');
    if (forceBtn) {
        forceBtn.addEventListener('click', function(){
            var btn = this;
            btn.disabled = true;
            fetch(runUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({})
            }).then(function(){
                btn.disabled = false;
                // Refresh count after trigger
                refresh();
            }).catch(function(){ btn.disabled = false; });
        });
    }
    refresh();
    setInterval(refresh, 5000);
})();
</script>
{% endblock %}



{% extends 'adminTemplate/base.html.twig' %}
{% set page_title %}Edit Product Bulk Generate Job #{{ product_bulk_generate.id }}{% endset %}

{% block breadcrumb %}
    <div class="breadcrumb-line">
        <ul class="breadcrumb">
            <li><a href="{{ path('dashboard') }}"><i class="icon-home2 position-left"></i>Dashboard</a></li>
            <li><a href="{{ path('product_bulk_generate_index') }}">Product Bulk Generate</a></li>
            <li><a href="{{ path('product_bulk_generate_show', {'id': product_bulk_generate.id}) }}">Job #{{ product_bulk_generate.id }}</a></li>
            <li class="active">Edit</li>
        </ul>
    </div>
{% endblock %}

{% block body -%}
    <div class="panel panel-flat">
        <div class="panel-heading">
            <h5 class="panel-title">{{ page_title }}</h5>
            <div class="heading-elements">
                <a href="{{ path('product_bulk_generate_show', {'id': product_bulk_generate.id}) }}" class="btn btn-sm btn-default">
                    <i class="icon-eye position-left"></i> View
                </a>
                <a href="{{ path('product_bulk_generate_index') }}" class="btn btn-sm btn-default">
                    <i class="icon-arrow-left5 position-left"></i> Back to List
                </a>
            </div>
        </div>

        <div class="panel-body">
            {{ form_start(form, {'attr': {'class': 'form-horizontal', 'novalidate': 'novalidate'}}) }}
                
                <div class="form-group">
                    {{ form_label(form.generatedFor, null, {'label_attr': {'class': 'col-lg-2 control-label required'}}) }}
                    <div class="col-lg-10">
                        {{ form_widget(form.generatedFor) }}
                        {{ form_errors(form.generatedFor) }}
                        <span class="help-block">{{ form_help(form.generatedFor) }}</span>
                    </div>
                </div>

                <div class="form-group">
                    {{ form_label(form.startDate, null, {'label_attr': {'class': 'col-lg-2 control-label required'}}) }}
                    <div class="col-lg-10">
                        {{ form_widget(form.startDate) }}
                        {{ form_errors(form.startDate) }}
                        <span class="help-block">{{ form_help(form.startDate) }}</span>
                    </div>
                </div>

                <div class="form-group">
                    {{ form_label(form.endDate, null, {'label_attr': {'class': 'col-lg-2 control-label'}}) }}
                    <div class="col-lg-10">
                        {{ form_widget(form.endDate) }}
                        {{ form_errors(form.endDate) }}
                        <span class="help-block">{{ form_help(form.endDate) }}</span>
                    </div>
                </div>

                <div class="form-group">
                    {{ form_label(form.admin, null, {'label_attr': {'class': 'col-lg-2 control-label required'}}) }}
                    <div class="col-lg-10">
                        {{ form_widget(form.admin) }}
                        {{ form_errors(form.admin) }}
                        <span class="help-block">{{ form_help(form.admin) }}</span>
                    </div>
                </div>

                <div class="form-group">
                    {{ form_label(form.totalRecommendations, null, {'label_attr': {'class': 'col-lg-2 control-label required'}}) }}
                    <div class="col-lg-10">
                        {{ form_widget(form.totalRecommendations) }}
                        {{ form_errors(form.totalRecommendations) }}
                        <span class="help-block">{{ form_help(form.totalRecommendations) }}</span>
                    </div>
                </div>

                <div class="form-group">
                    {{ form_label(form.status, null, {'label_attr': {'class': 'col-lg-2 control-label required'}}) }}
                    <div class="col-lg-10">
                        {{ form_widget(form.status) }}
                        {{ form_errors(form.status) }}
                        <span class="help-block">{{ form_help(form.status) }}</span>
                    </div>
                </div>

                <div class="form-group">
                    {{ form_label(form.processedCount, null, {'label_attr': {'class': 'col-lg-2 control-label'}}) }}
                    <div class="col-lg-10">
                        {{ form_widget(form.processedCount) }}
                        {{ form_errors(form.processedCount) }}
                        <span class="help-block">{{ form_help(form.processedCount) }}</span>
                    </div>
                </div>

                <div class="form-group">
                    {{ form_label(form.errorCount, null, {'label_attr': {'class': 'col-lg-2 control-label'}}) }}
                    <div class="col-lg-10">
                        {{ form_widget(form.errorCount) }}
                        {{ form_errors(form.errorCount) }}
                        <span class="help-block">{{ form_help(form.errorCount) }}</span>
                    </div>
                </div>

                <div class="form-group">
                    {{ form_label(form.adminNote, null, {'label_attr': {'class': 'col-lg-2 control-label'}}) }}
                    <div class="col-lg-10">
                        {{ form_widget(form.adminNote) }}
                        {{ form_errors(form.adminNote) }}
                        <span class="help-block">{{ form_help(form.adminNote) }}</span>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-lg-offset-2 col-lg-10">
                        <button type="submit" class="btn btn-primary">
                            <i class="icon-checkmark3 position-left"></i> Update Job
                        </button>
                        <a href="{{ path('product_bulk_generate_show', {'id': product_bulk_generate.id}) }}" class="btn btn-default">
                            <i class="icon-cross2 position-left"></i> Cancel
                        </a>
                    </div>
                </div>

            {{ form_end(form) }}
        </div>
    </div>

    {# Current Status Information #}
    <div class="panel panel-flat">
        <div class="panel-heading">
            <h6 class="panel-title">Current Status</h6>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="dl-horizontal">
                        <dt>Type:</dt>
                        <dd>
                            <span class="label {{ product_bulk_generate.generatedForBadgeClass }}">
                                <i class="{{ product_bulk_generate.generatedForIcon }} position-left"></i>
                                {{ product_bulk_generate.generatedForLabel }}
                            </span>
                        </dd>
                        
                        <dt>Current Status:</dt>
                        <dd>
                            <span class="label {{ product_bulk_generate.statusBadgeClass }}">
                                {{ product_bulk_generate.status|title }}
                            </span>
                        </dd>
                        
                        <dt>Progress:</dt>
                        <dd>
                            <div class="progress progress-micro">
                                {% set progress = product_bulk_generate.totalRecommendations > 0 ? (product_bulk_generate.processedCount / product_bulk_generate.totalRecommendations * 100)|round : 0 %}
                                <div class="progress-bar {% if product_bulk_generate.isCompleted %}bg-success{% elseif product_bulk_generate.isFailed %}bg-danger{% else %}bg-primary{% endif %}" 
                                     style="width: {{ progress }}%"></div>
                            </div>
                            {{ product_bulk_generate.processedCount }}/{{ product_bulk_generate.totalRecommendations }} ({{ product_bulk_generate.successRate }}%)
                        </dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="dl-horizontal">
                        <dt>Start Date:</dt>
                        <dd>{{ product_bulk_generate.startDate ? product_bulk_generate.startDate|dateTimeFormat : '--' }}</dd>
                        
                        <dt>End Date:</dt>
                        <dd>{{ product_bulk_generate.endDate ? product_bulk_generate.endDate|dateTimeFormat : '--' }}</dd>
                        
                        <dt>Duration:</dt>
                        <dd>
                            {% if product_bulk_generate.durationInSeconds %}
                                {% set duration = product_bulk_generate.durationInSeconds %}
                                {% if duration > 3600 %}
                                    {{ (duration / 3600)|round(1) }}h
                                {% elseif duration > 60 %}
                                    {{ (duration / 60)|round(1) }}m
                                {% else %}
                                    {{ duration }}s
                                {% endif %}
                            {% else %}
                                --
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    {# Audit Information #}
    <div class="panel panel-flat">
        <div class="panel-heading">
            <h6 class="panel-title">Audit Information</h6>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="dl-horizontal">
                        <dt>Created:</dt>
                        <dd>{{ product_bulk_generate.created|dateTimeFormat }}</dd>
                        <dt>Created by:</dt>
                        <dd>{{ product_bulk_generate.creator }}</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="dl-horizontal">
                        <dt>Modified:</dt>
                        <dd>{{ product_bulk_generate.modified|dateTimeFormat }}</dd>
                        <dt>Modified by:</dt>
                        <dd>{{ product_bulk_generate.modifiedBy }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="{{ asset('admin/js/plugins/forms/selects/select2.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('admin/js/plugins/pickers/pickadate/picker.js') }}"></script>
    <script type="text/javascript" src="{{ asset('admin/js/plugins/pickers/pickadate/picker.date.js') }}"></script>
    <script type="text/javascript" src="{{ asset('admin/js/plugins/pickers/pickadate/picker.time.js') }}"></script>
    <script type="text/javascript" src="{{ asset('admin/js/plugins/forms/validation/validate.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('admin/js/pages/form_validation.js') }}"></script>

    <script>
        $(function() {
            // Initialize Select2
            $('.select2').select2({
                placeholder: function() {
                    return $(this).data('placeholder');
                },
                allowClear: true
            });

            // Initialize datetime pickers
            $('.datetimepicker').pickadate({
                format: 'yyyy-mm-dd',
                formatSubmit: 'yyyy-mm-dd'
            });

            // Form validation
            $('form').validate({
                rules: {
                    'product_bulk_generate[generatedFor]': {
                        required: true
                    },
                    'product_bulk_generate[startDate]': {
                        required: true
                    },
                    'product_bulk_generate[admin]': {
                        required: true
                    },
                    'product_bulk_generate[totalRecommendations]': {
                        required: true,
                        min: 1
                    },
                    'product_bulk_generate[status]': {
                        required: true
                    },
                    'product_bulk_generate[processedCount]': {
                        min: 0,
                        max: function() {
                            return parseInt($('#product_bulk_generate_totalRecommendations').val()) || 0;
                        }
                    },
                    'product_bulk_generate[errorCount]': {
                        min: 0,
                        max: function() {
                            return parseInt($('#product_bulk_generate_totalRecommendations').val()) || 0;
                        }
                    }
                },
                messages: {
                    'product_bulk_generate[generatedFor]': {
                        required: "Please select a generation type"
                    },
                    'product_bulk_generate[startDate]': {
                        required: "Please select a start date"
                    },
                    'product_bulk_generate[admin]': {
                        required: "Please select an admin user"
                    },
                    'product_bulk_generate[totalRecommendations]': {
                        required: "Please enter the total recommendations",
                        min: "Total recommendations must be at least 1"
                    },
                    'product_bulk_generate[status]': {
                        required: "Please select a status"
                    },
                    'product_bulk_generate[processedCount]': {
                        min: "Processed count cannot be negative",
                        max: "Processed count cannot exceed total recommendations"
                    },
                    'product_bulk_generate[errorCount]': {
                        min: "Error count cannot be negative",
                        max: "Error count cannot exceed total recommendations"
                    }
                }
            });

            // Show/hide end date based on status
            $('#product_bulk_generate_status').change(function() {
                var status = $(this).val();
                var $endDateGroup = $('#product_bulk_generate_endDate').closest('.form-group');
                
                if (status === 'completed' || status === 'failed') {
                    $endDateGroup.show();
                    if (!$('#product_bulk_generate_endDate').val()) {
                        // Set current datetime as default end date
                        var now = new Date();
                        var dateStr = now.getFullYear() + '-' + 
                                     String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                                     String(now.getDate()).padStart(2, '0');
                        $('#product_bulk_generate_endDate').val(dateStr);
                    }
                } else {
                    $endDateGroup.hide();
                    $('#product_bulk_generate_endDate').val('');
                }
            }).trigger('change');

            // Validate progress consistency
            function validateProgress() {
                var total = parseInt($('#product_bulk_generate_totalRecommendations').val()) || 0;
                var processed = parseInt($('#product_bulk_generate_processedCount').val()) || 0;
                var errors = parseInt($('#product_bulk_generate_errorCount').val()) || 0;
                
                if (processed + errors > total) {
                    swal("Warning", "Processed count + Error count cannot exceed Total recommendations!", "warning");
                    return false;
                }
                return true;
            }

            $('#product_bulk_generate_processedCount, #product_bulk_generate_errorCount').blur(validateProgress);
        });
    </script>
{% endblock %}





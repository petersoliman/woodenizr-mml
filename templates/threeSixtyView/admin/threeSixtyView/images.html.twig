{% extends 'adminTemplate/base.html.twig' %}
{% set page_title %}{{ entity.title }}' 360 Images List{% endset %}
{% import 'adminTemplate/macros.html.twig' as macros %}

{% block stylesheets %}
    {{ parent() }}
{% endblock stylesheets %}
{% block breadcrumb %}
    <div class="breadcrumb-line">
        <ul class="breadcrumb">
            <li><a href="{{ path('dashboard') }}"><i class="icon-home2 position-left"></i>Dashboard</a></li>
            <li><a href="{{ path('product_index') }}">Products List</a></li>
            <li>
                <a href="{{ path('product_edit', {"id": entity.id}) }}">Edit {{ entity.title }}</a>
            </li>
            <li class="active">{{ page_title }}</li>
        </ul>
    </div>
{% endblock %}
{% block body %}
    <div class="row">
        <div class="col-lg-6">
            {{ form_start(form, {'attr':{"data-toggle":"validator",'novalidate':'novalidate'} }) }}
            <div class="panel panel-flat">
                <div class="panel-body">
                    {{ macros.input(form.imageExtension, 6) }}
                </div>
                <div class="panel-footer">
                    {% include 'adminTemplate/saveAndResetFormFooter.html.twig' %}
                </div>
            </div>
            {{ form_end(form) }}
            <div class="panel panel-flat">
                <div class="panel-heading">
                    <h6 class="no-margin-top mb-10">
                        <strong>Images Dimensions:</strong> 1000px * 1000px
                    </h6>
                    <h6 class="no-margin-top mb-10">
                        <strong>Images Extension:</strong> {{ threeSixtyView.imageExtensionName }}
                    </h6>
                </div>
                <div class="panel-body">
                    <div class="html5-uploader">
                        <p>Your browser doesn't support native upload.</p>
                    </div>
                    {# <div class="file-loading">
                        <input id="input-ficons-2" name="files[]" multiple type="file">
                    </div> #}
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="panel panel-flat">
                <div class="panel-heading">
                    <h5 class="panel-title">
                        360 Preview
                        <a href="{{ path('three_sixty_view_images', {"id": threeSixtyView.id}) }}" data-popup="tooltip" title="Refresh"><i class="icon-sync"></i></a>
                    </h5>
                </div>
                <div class="panel-body">
                    {% if threeSixtyView.images.count > 0 %}
                        {% set firstImage = threeSixtyView.images.first %}
                        {% set basePath = firstImage.assetPath|replace({(firstImage.name) : ''}) %}
                        <div
                                class="cloudimage-360"
                                id="car-suv"
                                data-folder="{{ absolute_url(asset(basePath)) }}"
                                data-filename-x="image-{index}.{{ firstImage.nameExtension }}?v={{ random() }}"
                                data-amount-x="{{ threeSixtyView.images.count }}"
                        ></div>
                        {# <div class="app-figure" id="zoom-fig" style="width: 100%;">
                            <a id="spin-1" class="Magic360" href="{{ asset(threeSixtyView.images.first.assetPath) }}">
                                <img src="{{ asset(threeSixtyView.images.first.assetPathThumb) }}" alt="{{ entity.title }}">
                            </a>
                        </div> #}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    <!-- Ajax sourced data -->
    <div class="panel panel-flat">
        <div class="panel-heading">
            <h6 class="panel-title">Images<a class="heading-elements-toggle"><i class="icon-more"></i></a></h6>
            <div class="heading-elements">
                <div class="heading-btn">
                    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#modal-all-delete">Delete All Images</button>
                </div>
            </div>
        </div>
        <div class="panel-body">
            <table class="table sorted_table">
                <thead>
                <tr>
                    <th>Sort No.</th>
                    <th class="text-center">Image</th>
                    <th class="text-center">Dimensions</th>
                    <th class="text-center">Extension</th>
                    <th class="text-center">Size</th>
                    <th class="text-center">Action</th>
                </tr>
                </thead>
                <tbody id="image-list">

                {% for image in threeSixtyView.images %}
                    {% include 'threeSixtyView/admin/threeSixtyView/imageItem.html.twig' %}
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- /ajax sourced data -->

{% endblock %}
{% block modalCode %}
    <div id="modal-all-delete" class="modal fade">
        <div class="modal-dialog modal-xs">
            <div class="modal-content bg-danger-600">
                <div class="modal-header bg-danger-600">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h6 class="modal-title">Be careful</h6>
                </div>

                <form method="post" action="{{ path('three_sixty_view_images_all_delete', {"id": threeSixtyView.id}) }}">
                    <div class="modal-body text-center">
                        <h2>Are you sure?</h2>
                        <p>Are you sure you want to delete all images?</p>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" id="modal-delete-bt" class="btn bg-danger-700">Delete</button>
                        <button type="reset" class="btn btn-link text-white" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-delete" class="modal fade">
        <div class="modal-dialog modal-xs">
            <div class="modal-content bg-danger-600">
                <div class="modal-header bg-danger-600">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h6 class="modal-title">Be careful</h6>
                </div>

                <form method="post" id="change-state-form" action="#">
                    <div class="modal-body text-center">
                        <h2>Are you sure?</h2>
                        <p>Are you sure you want to delete this image?</p>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" id="modal-delete-bt" class="btn bg-danger-700">Delete</button>
                        <button type="reset" class="btn btn-link text-white" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock modalCode %}
{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('admin/js/plugins/media/fancybox.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('admin/js/plugins/uploaders/fileinput/plugins/purify.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('admin/js/plugins/uploaders/fileinput/fileinput.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('admin/js/core/libraries/jquery_ui/interactions.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('admin/js/plugins/uploaders/plupload/plupload.full.min.js') }}"></script>
    <script src="{{ asset('admin/js/plugins/uploaders/plupload/plupload.queue.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('admin/js/plugins/forms/selects/select2.min.js') }}"></script>
    {% if threeSixtyView.images.count > 0 %}
        <script src="{{ asset('bundles/threesixtyview/cloudimage-360/js-cloudimage-360-view.js') }}"></script>
{#        <script src="https://scaleflex.cloudimg.io/v7/plugins/js-cloudimage-360-view/latest/js-cloudimage-360-view.min.js?func=proxy"></script>#}
    {% endif %}
    <script type="text/javascript">
        $(document).ready(function () {
            $(".sorted_table tbody").sortable({
                update: function (event, ui) {
                    $this = $(this);
                    var data = $this.sortable('serialize');
                    $this.sortable('option', 'disabled', true);
                    $.post('{{ path('three_sixty_view_images_sort_sort_ajax',{'id':threeSixtyView.id}) }}', data, function (response) {
                        $("#image-list tr").remove();
                        location.reload();
                        // response.images.forEach(function (image) {
                        //     $("#image-list").append(image);
                        // });
                        $this.sortable('option', 'disabled', false);
                        successNotify(response.message);
                    }, 'JSON');
                }
            });
            $('[data-popup="lightbox"]').fancybox({
                padding: 3,
                prevEffect: 'none',
                nextEffect: 'none',
            });
           var uploader= $(".html5-uploader").pluploadQueue({
                // General settings
                runtimes: 'html5',
                url: '{{ path('three_sixty_view_images_upload_images' , { 'id': threeSixtyView.id}) }}',
                chunk_size: '300Kb',
                max_file_size : '2mb',
                unique_names: true,
                // Sort files
                sortable: true,
                // Enable ability to drag'n'drop files onto the widget (currently only HTML5 supports that)
                dragdrop: true,
                views: {
                    list: true,
                    thumbs: true, // Show thumbs
                    active: 'thumbs'
                },
                filters: {
                    max_file_size: '2Mb',
                    mime_types: [{
                        title: "Image files",
                        extensions: "{{ threeSixtyView.imageExtensionName }}"
                    }]
                },
                init: {
                    FileUploaded: function (up, file, info) {// Called when file has finished uploading
                        // console.log('[FileUploaded] File:', file, "Info:", info);
                        $('#noFiles').addClass('hidden');
                        var response = JSON.parse(info.response);
                        $.each(response, function (index, value) {
                            $('#image-list').append(value);
                        });
                    },
                    /*UploadComplete: function (up, files) {// Called when all files are either uploaded or failed
                        console.log('[UploadComplete]', up, files);
                        if (up.total.uploaded == up.files.length) {
                            $(".plupload_buttons").css("display", "inline");
                            $(".plupload_upload_status").css("display", "inline");
                            up.refresh();
                            // up.init();
                        }
                    },*/
                }
            });

            /*$("#input-ficons-2").fileinput({
                uploadUrl: "{{ path('three_sixty_view_images_upload_images' , { 'id': threeSixtyView.id}) }}",
                uploadAsync: true,
                dropZoneTitle: "Drag & drop images here ...",
                showUploadedThumbs: false,
                previewFileIcon: '<i class="icon icon-file"></i>',
                allowedFileExtensions: ['{{ threeSixtyView.imageExtensionName }}'],
                previewThumbTags: {
                    '{TAG_VALUE}': '', // no value
                    '{TAG_CSS_NEW}': '', // new thumbnail input
                    '{TAG_CSS_INIT}': 'kv-hidden'  // hide the initial input
                },
            }).on('fileuploaded', function (event, data, previewId, index) {
                if ((data.response).length > 0) {
                    $('#noFiles').addClass('hidden');
                    $.each(data.response, function (index, value) {
                        $('#image-list').append(value);
                    });
                }
            });*/

            $('body').on("click", ".delete", function (e) {
                action = $(this).data('action');
                $('#modal-delete form').attr("action", action);
                $('#modal-delete').modal('show');
            });
        });
    </script>
{% endblock javascripts %}
